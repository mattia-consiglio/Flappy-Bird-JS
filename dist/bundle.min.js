document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementsByTagName("body")[0],t=document.getElementById("game"),n=document.getElementById("score"),a=document.getElementById("enableDebugCheckbox"),r=document.getElementById("gravityRange"),l=document.getElementById("speedRange"),s=document.querySelectorAll('[name = "birdColor"]'),o={},i={fps:document.getElementById("fps"),deltaTimeMultiplier:document.getElementById("deltaTimeMultiplier"),isRunning:document.getElementById("isRunning"),isFalling:document.getElementById("isFalling"),birdY:document.getElementById("birdY"),birdRotation:document.getElementById("birdRotation"),gravityIncrement:document.getElementById("gravityIncrement"),birdIsCollided:document.getElementById("birdIsCollided"),speedIncrement:document.getElementById("speedIncrement")},d=t.offsetWidth,c=t.offsetHeight,g=34,m=24,u=52,p=50,b=Math.PI/4,f=-1*b,y=b/4,I=f/4,h=112,v=1e3/60;let E=null,x=!1,M=(c-h-12)/2,$=0,w=0,C=[],S=parseInt(localStorage.getItem("bestScore")||"")||0,B=!1,F=0,R=0,Y=0,k=0,A=1,L=performance.now();const G=localStorage.getItem("settings")?JSON.parse(localStorage.getItem("settings")):{baseGravity:.25,speedMultiplier:1,birdColor:"yellow",debugEnable:!1},T=document.createElement("canvas");T.width=d,T.height=c,t.appendChild(T);const q=T.getContext("2d");let D=new Image;const X=new Image;X.src="assets/sprites/pipe-green.png";const N=new Image;N.src="assets/sprites/base.png";const O=new Image;O.src="assets/sprites/gameover.png";const J=new Image;J.src="assets/sprites/background-day.png";const P=(e,t)=>{G.debugEnable&&(i[t].innerText=e)},H=(e,t)=>{const n=Math.abs(-3.5)*(G.baseGravity/.25),a=Math.ceil(m+n*G.speedMultiplier*A),r=Math.max(a,65),l=Math.floor(Math.random()*(150-r+1))+r,s=e?Math.min(e,c-l-120):c-l-120,o=t?Math.max(t,132):132;return[l,Math.random()*(s-o)+o,Math.floor(101*Math.random())+100]},W=()=>{let e,t,n;if(C.length>0){const a=C[C.length-1],r=a.gapX+u+u;let[l,s]=((e,t,n,a)=>{const r=Math.abs(a-e);if(r>n)return null;const l=Math.sqrt(n*n-r*r);return[t-l,t+l]})(a.x+u,a.y,r,a.x+a.gapX+u);[e,t,n]=H(s,l)}else[e,t,n]=H();const a={x:d,y:t,gapY:e,gapX:n,scored:!1};return a.x=d,a},j=c-h;let z=0,K=0;const Q=()=>{if(!q)return;q.clearRect(0,0,d,c),F=Math.min(b,Math.max(f,.1*$)),D=F<y?o[`assets/sprites/${G.birdColor}bird-upflap.png`]:F>I?o[`assets/sprites/${G.birdColor}bird-downflap.png`]:o[`assets/sprites/${G.birdColor}bird-midflap.png`],x?(K-=(2+k)*G.speedMultiplier*A*.2,K<=-288&&(K=0)):K=0;let e=K;for(q.save();e<d;)q.drawImage(J,e,0),e+=287;q.restore(),q.save(),q.translate(67,M+12),q.rotate(F),q.drawImage(D,-17,-12,g,m),q.restore(),C.forEach((e=>{q.save(),q.translate(e.x+26,e.y),q.scale(1,-1),q.drawImage(X,-26,0),q.restore(),q.drawImage(X,e.x,e.y+e.gapY),P(`${x}`,"isRunning"),P(`${M}`,"birdY"),P(`${F}`,"birdRotation")})),x&&(z-=(2+k)*G.speedMultiplier*A,z<=-336&&(z=0));let t=z;for(;t<d;)q.drawImage(N,t,j),t+=335},U=()=>{w>S&&(S=w,localStorage.setItem("bestScore",S.toString()))},V=()=>{if(q){if(P(`${B}`,"isFalling"),B){$+=G.baseGravity,M+=$;const e=C[0];if(M+m>c-h&&67<=e.x)M=c-h-m,$=0,B=!1,U(),Z();else if(M<e.y+e.gapY&&M+m>e.y+e.gapY&&84>e.x&&p<e.x+u)return M=e.y+e.gapY,$=0,B=!1,U(),void Z();const t=Math.min(b,Math.max(f,.1*$));Q(),q.save(),q.translate(67,M+12),q.rotate(t),q.drawImage(D,-17,-12,g,m),q.restore(),requestAnimationFrame(V)}else U(),Z();P(`${B}`,"isFalling")}},Z=()=>{if(P(`${x}`,"isRunning"),P(`${B}`,"isFalling"),!q)return;q.fillStyle="rgba(0, 0, 0, 0.5)",q.fillRect(0,0,d,c);const e=(d-192)/2;q.drawImage(O,e,150,192,42),q.fillStyle="#fff",q.font="20px Arial",q.textAlign="center",q.fillText(`Your Best Score: ${S}`,d/2,222),cancelAnimationFrame(E),E=null},_=e=>{if(!x)return;const t=e-L;A=t/v,L=e,P(`${Math.round(1e3/t)}`,"fps"),P(`${A}`,"deltaTimeMultiplier"),$+=G.baseGravity,M+=$,M+=Y,M<0?(M=0,$=0):M>c-m&&(M=c-m,$=0),(()=>{const e=C.length>0?C[C.length-1]:null;(null===e||(null==e?void 0:e.x)<d-e.gapX)&&C.push(W()),C=C.filter((e=>(e.x-=(2+k)*G.speedMultiplier*A,!(e.x+u<0))))})(),C.forEach((e=>{e.x+u<p&&!e.scored&&n&&(w++,e.scored=!0,n.textContent=w.toString(),Y+=.01,k+=.02)})),P(`${Y}`,"gravityIncrement"),P(`${k}`,"speedIncrement"),(()=>{const e=p,t=84,n=M,a=M+m,r=C[0],l=r.x,s=r.x+u,o=r.y,i=r.x,d=r.x+u,g=r.y+r.gapY,b=t>=l&&e<=s&&n<=o||t>=i&&e<=d&&a>=g||M+m>=c-h;return P(`${b}`,"birdIsCollided"),b})()?(x=!1,R=Date.now(),M+m>c-h?(M=c-h-m,$=0,U(),Z()):(B=!0,V())):(Q(),E=requestAnimationFrame(_))},ee=()=>{x?$=-3.5:Date.now()-R>=1500&&(x=!0,M=(c-h-12)/2,$=0,w=0,C=[],n&&(n.textContent="0"),L=performance.now(),Y=0,k=0,requestAnimationFrame(_),P(`${x}`,"isRunning"),P(`${B}`,"isFalling"),P(`${M}`,"birdY"),P(`${F}`,"birdRotation"),P(`${Y}`,"gravityIncrement"),P(`${k}`,"speedIncrement"))},te=()=>{localStorage.setItem("settings",JSON.stringify(G))},ne=e=>{const t=parseFloat(e.max),n=parseFloat(e.min),a=parseFloat(e.value);let r=0;a>n&&(r=Math.floor((a-n)/(t-n)*100)),e.style.setProperty("--value",r+"%")},ae=(e,t=!1)=>{if(e===G.debugEnable&&!t)return;G.debugEnable=e,te();const n=document.getElementById("debugInfo");n&&(n.style.display=e?"block":"none",t&&a&&(a.checked=e))},re=(t,n=!1)=>{if(t===G.birdColor&&!n)return;if(G.birdColor=t,e.setAttribute("class",G.birdColor),te(),0===Array.from(s).filter((e=>!0===e.checked&&e.value===t)).length){s.forEach((e=>{e.checked=!1}));const e=Array.from(s).filter((e=>e.value===t))[0];e&&(e.checked=!0)}if(["red","blue","yellow"].includes(t)){[`assets/sprites/${t}bird-upflap.png`,`assets/sprites/${t}bird-midflap.png`,`assets/sprites/${t}bird-downflap.png`].forEach((e=>{if(!o[e]){const t=new Image;t.src=e,o[e]=t}})),n&&(D=o[`assets/sprites/${t}bird-midflap.png`]),Q()}};document.addEventListener("keydown",(e=>{"Space"===e.code&&(e.preventDefault(),ee())})),null==t||t.addEventListener("click",ee),s.forEach((e=>{e.addEventListener("change",(()=>{console.log(e.value),re(e.value)}))})),null==a||a.addEventListener("change",(e=>{const t=e.target;ae(t.checked)})),null==r||r.addEventListener("input",(e=>{const t=e.target;G.baseGravity=parseFloat(t.value),te(),ne(t)})),null==l||l.addEventListener("input",(e=>{const t=e.target;G.speedMultiplier=parseFloat(t.value),te(),ne(t)})),r.value=G.baseGravity.toString(),l.value=G.speedMultiplier.toString(),ne(r),ne(l),re(G.birdColor,!0),ae(G.debugEnable,!0),J.onload=D.onload=X.onload=N.onload=()=>{Q()}}));